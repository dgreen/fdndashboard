<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Financial Dashboard">
    <meta name="keywords" content="dashboard, guage, information">
    <meta name="author" content="David Green">

    <title>
        IEEE Foundation Dashboard 
    </title>

    <link href="http://fonts.googleapis.com/css?family=Roboto:300,400,500,700,400italic" rel="stylesheet">
    
    <link href="assets/css/toolkit-light.css" rel="stylesheet">
    <link href="assets/css/application.css" rel="stylesheet">

    <style>
      /* note: this is a hack for ios iframe for bootstrap themes shopify page */
      /* this chunk of css is not part of the toolkit :) */
      body {
        width: 1px;
        min-width: 100%;
        *width: 100%;
      }
    </style>

    <style>
      h5 {
        color: darkblue;
        text-align: left;
        font-weight: bold;
        font-size: 18pt;
        margin-bottom: 10px;
      }

      .notes {
        margin-bottom: 40px;
      }

      .dbPane {
         width:400px;
         height:400px;
      }

      #notes {
        height: 180px;
        font-family: Arial, Helvetica, sans-serif;  
        font-size: 24px;
        color: darkblue; 
      }

      .dashhead-title {
        color: darkblue;
        font-size: 300%;
        font-weight: bold;
      }

      .niinotes {
        font-family: Arial, Helvetica, sans-serif;
        color: darkblue;
        /** position: relative; */
        text-align: left;
        margin-left: 30px;
      }

    </style>

  </head>

  <body>

<div class="without-iconav">

  <div class="container-fluid">
    <div class="dashhead">
      <div class="dashhead-titles">
        <h3 class="dashhead-title">IEEE Foundation Financial Dashboard</h3>
      </div>

      <div class="dashhead-toolbar">
        <div class="input-with-icon dashhead-toolbar-item">
          <input id='cal1' type="text" value="04/01/2019" class="form-control" data-provide="datepicker">
          <span class="icon icon-calendar"></span>
        </div>
      </div>
    </div>

    <hr class="my-4">

    <div class="tab-content">
      <div role="tabpanel" class="tab-pane active" id="traffic1">
        <div class="row text-center m-t-md">

          <div class="col-md-3 mb-5">
            <h5 id='de-title'><span class="icon icon-hour-glass"> Days Expended</span></h5>
            <div class="w-3">
              <canvas id='de' class='dbPane'></canvas>
            </div>
          </div>

          <div class="col-md-3 mb-5">
            <h5 id='capc-title'><span class="icon icon-heart"> Cash and Pledge Contributions</span></h5>           
            <div class="w-3">
              <canvas id='capc' class='dbPane' data-toggle='modal' data-target='#infoModal' data-whatever='capc'></canvas>
            </div>
          </div>

          <div class="col-md-3 mb-5">
            <h5 id='psvb-title'><span class="icon icon-export"> Program Support vs Budget</span></h5>
            <div class="w-3">
              <canvas id='psvb' class='dbPane' data-toggle='modal' data-target='#infoModal' data-whatever='psvb'></canvas>
            </div>
          </div>

          <div class="col-md-3 mb-5">
            <h5 id='afrvb-title'><span class="icon icon-cog"> Admin &amp; Fund Raising vs Budget</span></h5>
            <div class="w-3">
              <canvas id='afrvb' class='dbPane' data-toggle='modal' data-target='#infoModal' data-whatever='afrvb'></canvas>
            </div>
          </div>

        </div>
      </div>
    </div>

    <hr class="my-4">

    <div class="tab-content">
      <div role="tabpanel" class="tab-pane active" id="traffic2">
        <div class="row text-center m-t-md">
          <hr class="mt-0 mb-5">
          <div class="col-md-3 mb-5">
            <h5 id='nii-title'><span class="icon icon-credit"> Net Investment Income</span></h5>
            <div class="w-3">
              <canvas id='nii' class='dbPane' data-toggle='modal' data-target='#infoModal' data-whatever='nii'></canvas>
            </div>
            <p class="niinotes">
              Subject to market variations.<br>
              YTD <span id='niiPctYTD'>4.5</span>% with Budget of <span id='niiPctGoal'>6</span>%
            </p>
          </div>
          <div class="col-md-3 mb-5">
            <h5 id='pter-title'><span class="icon icon-gauge"> Program to Expense Ratio</span></h5>
            <div class="w-3">
              <canvas id='pter' class='dbPane' data-toggle='modal' data-target='#infoModal' data-whatever='pter'></canvas>
            </div>
          </div>
          <div class="col-md-6 mb-5">
            <div>
              <h5 class=notes><span class="icon icon-note"> Notes</span></h5>
              <div class="input-group">
                <textarea id=notes class="form-control" aria-label="With textarea">No issues to highlight at this point</textarea>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <hr class="my-4">

  </div>

  <div id="infoModal" class="modal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Change Value on <span id=topicInfo>Generic</span> Gauge</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <p>Value: <input type='text' id='infoValue'></p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          <button type="button" id="infoSave" class="btn btn-primary">Save changes</button>
        </div>
      </div>
    </div>
  </div>
</div>

    <script src="assets/js/jquery.min.js"></script>
    <script src="assets/js/tether.min.js"></script>
    <script src="assets/js/chart.bundle.min.js"></script>
    <script src="assets/js/tablesorter.min.js"></script>
    <script src="assets/js/toolkit.js"></script>
    <script src="assets/js/application.js"></script>
    <script src="assets/js/Gauge.js"></script>
    <script src="initData.js"></script>
    <script>
      // execute/clear BS loaders for docs
      $(function(){while(window.BS&&window.BS.loader&&window.BS.loader.length){(window.BS.loader.pop())()}})
    </script>

    <script>
    // activities related to initialization after initData.js loads
    function days_of_a_year(year) 
    {   
      return isLeapYear(year) ? 366 : 365;
    }

    function isLeapYear(year) {
      return year % 400 === 0 || (year % 100 !== 0 && year % 4 === 0);
    }

    function computeMax(value) {
      return Math.round(value * 1.5);
    }

    function computePosition(value, toBudget) {
      return value / toBudget;
    }

    var deBudget                = days_of_a_year(new Date(deDate).getFullYear());
    var deValue                 = 90; // will be overridden

    var position                = computePosition(deValue, deBudget);

    var pterCharityNavigator    = 75;
    var pterMinTarget           = 78;

    var niiMax                  = Math.round(niiBudget * (20./6.));    // 20% gain
    var niiMin                  = Math.round(-niiBudget * (10./6.));   // 10% loss
    var pterMax                 = 100;
    </script>


    <script>
    function baseChartData() {
      var data = {
        datasets: [{
          label: 'Net Investment Income',
          gaugeLimits: [0, 66.66666, 100],
          limitVisibilty: [true, true, true, true, true, true, true],
          backgroundColor: [
              `darkorange`,
              `darkblue`
          ],
          gaugeData: {
            value: 1500,
            valueColor: "#ff7143"
          },
          borderWidth: 0
        }]
      };
      return data;
    }

    function baseChartOptions() {
      var options = {        
        cutoutPercentage: 90,
        defaultFontSize: 11,
        animate: false,
        tooltips: {
          enabled: false
        }
      };
      return options;
    }

    function drawGauge(name, data, options) {
      var ctx = document.getElementById(name);
      gauge = new Chart(ctx, {
        type: 'tsgauge',
        data: data,
        options: options
      });
      return gauge;
    }

    // name of gauge, planned value at end of year
    function drawCommonAngleGauge(name, plan, value) {
      var data = baseChartData();
      let gaugeMax = computeMax(plan);

      // Draw position in year unless year end

      if (position < 1.0) {
        let barLow  = Math.round( (position-.01) * plan);
        let barHigh = Math.round((position+.01) * plan);
        data.datasets[0].gaugeLimits = [0, barLow, barHigh, plan, gaugeMax];
        data.datasets[0].limitVisibilty = [ true, false, false, true, name == 'de' ? false : true];
        data.datasets[0].backgroundColor = [ 'darkorange', 'black', 'darkorange', 'darkblue' ];
      } else {
        data.datasets[0].gaugeLimits = [0, plan, gaugeMax];
        data.datasets[0].limitVisibilty = [ true, true, name == 'de' ? false : true];
        data.datasets[0].backgroundColor = [ 'darkorange', 'darkblue' ];
      }

      data.datasets[0].gaugeData.value = value;
      var options = baseChartOptions();
      var ctx = document.getElementById(name);
      gauge = new Chart(ctx, {
        type: 'tsgauge',
        data: data,
        options: options
      });
      return gauge;
    }

    function de() {
      return drawCommonAngleGauge('de', deBudget, deValue);
    }

    function capc() {
      return drawCommonAngleGauge('capc', capcBudget, capcValue);
    }

    function psvb() {
      return drawCommonAngleGauge('psvb', psvbBudget, psvbValue);
    }

    function afrvb() {
      return drawCommonAngleGauge('afrvb', afrvbBudget, afrvbValue);
    }

    function nii() {
      var data = baseChartData();
      data.datasets[0].gaugeLimits = [niiMin, 0, niiBudget, niiMax];
      data.datasets[0].backgroundColor = ['red', '#FFFF66', 'green'];
      data.datasets[0].gaugeData.value = niiValue;
  
      var options = baseChartOptions();

      return drawGauge('nii', data, options);
    }

    function pter() {
      var data = baseChartData();
      data.datasets[0].gaugeLimits = [0, pterCharityNavigator, pterMinTarget, pterMax];
      data.datasets[0].backgroundColor = ['red', '#FFFF66', 'green'];
      data.datasets[0].gaugeData.value = pterValue;
  
      var options = baseChartOptions();
      return drawGauge('pter', data, options);
    }

    // change height of all text box to be same as Admin &amp; Fund Raising vs Budget box
    // just visual clean up
    topRowHeadingHeight = $('#afrvb-title').innerHeight();
    $('#de-title'   ).innerHeight(topRowHeadingHeight);
    $('#capc-title' ).innerHeight(topRowHeadingHeight);
    $('#psvb-title' ).innerHeight(topRowHeadingHeight);
    $('#afrvb-title').innerHeight(topRowHeadingHeight);

    // set initial date from file
    $('#cal1').val(deDate);

    // draw the gauges
    deGauge    = de();
    capcGauge  = capc();
    psvbGauge  = psvb();
    afrvbGauge = afrvb();
    niiGauge   = nii();
    pterGauge  = pter();

    var canvasToGauge = {};
    canvasToGauge['de']    = deGauge;
    canvasToGauge['capc']  = capcGauge;
    canvasToGauge['psvb']  = psvbGauge;
    canvasToGauge['afrvb'] = afrvbGauge;
    canvasToGauge['nii']   = niiGauge;
    $('#niiPctYTD').text(niiPercentYTD);
    $('#niiPctGoal').text(niiPercentGoal);
    canvasToGauge['pter']  = pterGauge;

    $('#infoModal').on('show.bs.modal', function (event) {
      var infoCanvas = $(event.relatedTarget);        // Chart that triggered the modal
      var infoCanvasID = infoCanvas.data('whatever'); // Extract info from data-* attributes
      theGauge = canvasToGauge[infoCanvasID];
      titleInfoID = '#' + infoCanvasID + "-title";
      $('#infoValue').val(theGauge.config.data.datasets[0].gaugeData.value.toString(10));
      $('#topicInfo').text($(titleInfoID).text());
      $('#infoSave').click(function() {
        theGauge.config.data.datasets[0].gaugeData.value = parseFloat($('#infoValue').val()); 
        theGauge.update({duration:0,lazy: true});
        $('#infoModal').modal('hide');     
      });
    });

    function daysIntoYear(dateString) {
      dateObject     = new Date(dateString);
      // note:  +1 at end of equation is due to using the start of each day so .ceil does not help
      var theDay = Math.ceil((dateObject - new Date(dateObject.getFullYear(),0,1)) / 86400000) + 1;
      return theDay;
    }

    // refresh top row of gauges when date changes
    $('#cal1').on( 'change', function(event) {
      var dateString = $('#cal1').val();
      deValue = daysIntoYear(dateString);
      position = computePosition(deValue,deBudget);
      de();
      capc();
      psvb();
      afrvb();
    });

    </script>

  </body>
</html>

